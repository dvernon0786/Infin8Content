name: SM Validation

on:
  push:
    branches: [ sm-* ]
  pull_request:
    branches: [ test-main-all, develop ]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  sm-validation:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: ./infin8content/package-lock.json
        
    - name: Install dependencies
      working-directory: ./infin8content
      run: npm ci
      
    - name: Validate SM Documentation Presence
      run: |
        echo "ğŸ” Validating SM enforcement documentation presence..."
        
        # Check for SM classification in story files
        SM_FILES=$(find . -name "*sm*" -o -name "*story*" | head -10)
        if [ -n "$SM_FILES" ]; then
          echo "âœ… SM enforcement files found:"
          echo "$SM_FILES"
        else
          echo "âš ï¸ No SM enforcement files found"
        fi
        
        # Validate SM patterns documentation exists
        if [ -f "sm-enforcement-results-documentation.md" ]; then
          echo "âœ… SM results documentation found"
        else
          echo "âš ï¸ SM results documentation missing"
        fi
        
        # Check for scratchpad with SM content
        if [ -f "scratchpad.md" ]; then
          echo "âœ… Scratchpad documentation found"
          if grep -q "SM enforcement" scratchpad.md 2>/dev/null; then
            echo "âœ… SM enforcement content found in scratchpad"
          else
            echo "âš ï¸ SM enforcement content not found in scratchpad"
          fi
        else
          echo "âš ï¸ Scratchpad documentation missing"
        fi
        
    - name: Validate Business Documentation
      run: |
        echo "ğŸ“Š Validating business documentation presence..."
        
        # Check for business metrics documentation
        if [ -f "sm-enforcement-long-term-success-metrics.md" ]; then
          echo "âœ… Business metrics documentation found"
        else
          echo "âš ï¸ Business metrics documentation missing"
        fi
        
        # Check for knowledge transfer documentation
        if [ -f "sm-enforcement-knowledge-transfer.md" ]; then
          echo "âœ… Knowledge transfer documentation found"
        else
          echo "âš ï¸ Knowledge transfer documentation missing"
        fi
        
        # Check for maintenance documentation
        if [ -f "sm-enforcement-maintenance-schedule.md" ]; then
          echo "âœ… Maintenance documentation found"
        else
          echo "âš ï¸ Maintenance documentation missing"
        fi
        
    - name: Validate Platform Documentation
      run: |
        echo "ğŸ” Validating platform documentation..."
        
        # Check for implementation documentation
        if [ -f "sm-enforcement-implementation.md" ]; then
          echo "âœ… Implementation documentation found"
        else
          echo "âš ï¸ Implementation documentation missing"
        fi
        
        # Check for pattern documentation
        if [ -f "sm-pattern-refinement-production-usage.md" ]; then
          echo "âœ… Pattern documentation found"
        else
          echo "âš ï¸ Pattern documentation missing"
        fi
        
        # Check for guardrail documentation
        if [ -f "sm-guardrail-production-monitoring.md" ]; then
          echo "âœ… Guardrail documentation found"
        else
          echo "âš ï¸ Guardrail documentation missing"
        fi
        
    - name: Generate SM Evidence Report
      run: |
        echo "ğŸ“Š Generating SM enforcement evidence report..."
        
        mkdir -p reports
        
        # Count SM-related files
        SM_DOC_COUNT=$(find . -name "*sm*" -type f | wc -l)
        STORY_DOC_COUNT=$(find . -name "*story*" -type f | wc -l)
        
        # Generate evidence report (NO FABRICATED METRICS)
        cat > reports/sm-evidence-report.json << EOF
        {
          "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "evidence": {
            "smFilesFound": $SM_DOC_COUNT,
            "storyFilesFound": $STORY_DOC_COUNT,
            "documentationPresent": {
              "smResults": $(test -f "sm-enforcement-results-documentation.md" && echo "true" || echo "false"),
              "businessMetrics": $(test -f "sm-enforcement-long-term-success-metrics.md" && echo "true" || echo "false"),
              "knowledgeTransfer": $(test -f "sm-enforcement-knowledge-transfer.md" && echo "true" || echo "false"),
              "maintenance": $(test -f "sm-enforcement-maintenance-schedule.md" && echo "true" || echo "false"),
              "implementation": $(test -f "sm-enforcement-implementation.md" && echo "true" || echo "false"),
              "patterns": $(test -f "sm-pattern-refinement-production-usage.md" && echo "true" || echo "false"),
              "guardrails": $(test -f "sm-guardrail-production-monitoring.md" && echo "true" || echo "false"),
              "scratchpad": $(test -f "scratchpad.md" && echo "true" || echo "false")
            }
          },
          "status": "evidence_collected"
        }
        EOF
        
        echo "âœ… SM evidence report generated"
        
    - name: Upload SM Evidence Report
      uses: actions/upload-artifact@v4
      with:
        name: sm-evidence-report
        path: reports/
        retention-days: 30
        
    - name: Comment PR with Evidence Results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = JSON.parse(fs.readFileSync('reports/sm-evidence-report.json', 'utf8'));
          
          const comment = `
          ## ğŸ” SM Enforcement Evidence Report
          
          **Status:** Evidence Collected
          **SM Files Found:** ${report.evidence.smFilesFound}
          **Story Files Found:** ${report.evidence.storyFilesFound}
          
          ### ğŸ“‹ Documentation Evidence
          ${Object.entries(report.evidence.documentationPresent).map(([doc, present]) => 
            `- **${doc}:** ${present ? 'âœ… Found' : 'âŒ Missing'}`
          ).join('\n')}
          
          ### ğŸ“Š Summary
          This report validates the presence of SM enforcement documentation and evidence.
          No fabricated metrics are included - only evidence collection.
          
          ### ğŸ”— Resources
          - ğŸ“– [SM Enforcement Documentation](/sm-enforcement-results-documentation.md)
          - ğŸ¯ [Scratchpad](/scratchpad.md)
          
          [View detailed report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
